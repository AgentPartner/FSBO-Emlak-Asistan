{
  "name": "ğŸ“± FSBO WhatsApp Takip MesajlarÄ±",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 11,16 * * 1-6"
            }
          ]
        }
      },
      "id": "schedule-whatsapp",
      "name": "â° Her GÃ¼n 11:00 & 16:00",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [0, 0]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT l.*, cl.ozet, cl.recording_url\nFROM leads l\nJOIN call_logs cl ON l.vapi_call_id = cl.vapi_call_id\nWHERE l.durum IN ('arama_yapildi', 'tekrar_ara')\n  AND cl.randevu_alindi = false\n  AND cl.tekrar_ara = true\n  AND l.whatsapp_gonderildi IS NULL\n  AND cl.arama_bitis > NOW() - INTERVAL '24 hours'\nORDER BY cl.musteri_ilgisi DESC\nLIMIT 30",
        "options": {}
      },
      "id": "get-followup-leads",
      "name": "ğŸ“‹ Takip Edilecek Lead'ler",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [220, 0],
      "credentials": {
        "postgres": {
          "id": "postgres-db",
          "name": "PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "split-leads",
      "name": "ğŸ”€ Teker Teker",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [440, 0]
    },
    {
      "parameters": {
        "jsCode": "const lead = $input.first().json;\n\n// MÃ¼ÅŸteri ilgisine gÃ¶re mesaj ÅŸablonu seÃ§\nconst ilgi = lead.musteri_ilgisi || 5;\nlet mesaj = '';\n\nif (ilgi >= 7) {\n  // YÃ¼ksek ilgi - DoÄŸrudan randevu teklifi\n  mesaj = `Merhaba ${lead.ilan_sahibi || ''},\\n\\nBen AyÅŸe, Prestij Emlak'tan. Daha Ã¶nce gÃ¶rÃ¼ÅŸtÃ¼k ve mÃ¼lkÃ¼nÃ¼ze olan ilgimizi paylaÅŸmÄ±ÅŸtÄ±m.\\n\\nğŸ  ${lead.baslik || lead.il + ' ' + lead.ilce}\\nğŸ’° ${lead.fiyat_formatted || ''}\\n\\nSize Ã¶zel bir teklifimiz var: Ãœcretsiz profesyonel fotoÄŸraf Ã§ekimi + deÄŸerleme hizmeti.\\n\\nğŸ“… YarÄ±n veya bu hafta iÃ§i size uygun bir zaman var mÄ±?\\n\\nHemen randevu almak iÃ§in: 0212 XXX XX XX\\n\\nAyÅŸe YÄ±lmaz\\nPrestij Emlak`;\n} else if (ilgi >= 4) {\n  // Orta ilgi - Bilgi paylaÅŸÄ±mÄ±\n  mesaj = `Merhaba ${lead.ilan_sahibi || ''},\\n\\nBen AyÅŸe, Prestij Emlak'tan. KÄ±sa bir sÃ¼re Ã¶nce gÃ¶rÃ¼ÅŸtÃ¼k.\\n\\nğŸ“Š BÃ¶lgenizdeki son satÄ±ÅŸ verilerini inceledim:\\n- Ortalama satÄ±ÅŸ sÃ¼resi: 45 gÃ¼n\\n- Fiyat aralÄ±ÄŸÄ±: Uygun\\n\\nğŸ¯ Sizin mÃ¼lkÃ¼nÃ¼z iÃ§in Ã¶zel bir pazarlama stratejimiz var.\\n\\nDetaylÄ± bilgi iÃ§in beni arayabilirsiniz: 0212 XXX XX XX\\n\\nAyÅŸe YÄ±lmaz\\nPrestij Emlak`;\n} else {\n  // DÃ¼ÅŸÃ¼k ilgi - YumuÅŸak hatÄ±rlatma\n  mesaj = `Merhaba ${lead.ilan_sahibi || ''},\\n\\nBen AyÅŸe, Prestij Emlak'tan.\\n\\n${lead.il || ''} ${lead.ilce || ''}'deki mÃ¼lkÃ¼nÃ¼z iÃ§in yardÄ±mcÄ± olabileceÄŸimizi hatÄ±rlatmak istedim.\\n\\nâœ… Ãœcretsiz deÄŸerleme\\nâœ… Profesyonel fotoÄŸraf\\nâœ… 5000+ aktif alÄ±cÄ± portfÃ¶yÃ¼\\n\\nSorularÄ±nÄ±z iÃ§in: 0212 XXX XX XX\\n\\nÄ°yi gÃ¼nler dilerim,\\nAyÅŸe YÄ±lmaz`;\n}\n\nreturn [{\n  json: {\n    ...lead,\n    whatsapp_mesaj: mesaj,\n    telefon_formatted: '+90' + (lead.telefon || '').replace(/[^0-9]/g, '')\n  }\n}];"
      },
      "id": "prepare-message",
      "name": "ğŸ“ Mesaj HazÄ±rla",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [660, 0]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v18.0/{{$env.WHATSAPP_PHONE_ID}}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.telefon_formatted }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": {{ JSON.stringify($json.whatsapp_mesaj) }}\n  }\n}"
      },
      "id": "send-whatsapp",
      "name": "ğŸ“± WhatsApp GÃ¶nder",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [880, 0],
      "credentials": {
        "httpHeaderAuth": {
          "id": "whatsapp-api",
          "name": "WhatsApp Business API"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "schema": "public",
        "table": "leads",
        "updateKey": "id",
        "columns": "whatsapp_gonderildi, whatsapp_tarihi",
        "additionalFields": {
          "whatsapp_gonderildi": true,
          "whatsapp_tarihi": "={{ $now.toISO() }}"
        }
      },
      "id": "update-lead-whatsapp",
      "name": "ğŸ“ WhatsApp Durumu GÃ¼ncelle",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1100, 0],
      "credentials": {
        "postgres": {
          "id": "postgres-db",
          "name": "PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "amount": 5,
        "unit": "seconds"
      },
      "id": "wait-between",
      "name": "â³ 5sn Bekle",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [1320, 0]
    },
    {
      "parameters": {},
      "id": "loop-back",
      "name": "ğŸ”„ Sonraki",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [1540, 0]
    }
  ],
  "connections": {
    "â° Her GÃ¼n 11:00 & 16:00": {
      "main": [
        [
          {
            "node": "ğŸ“‹ Takip Edilecek Lead'ler",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‹ Takip Edilecek Lead'ler": {
      "main": [
        [
          {
            "node": "ğŸ”€ Teker Teker",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ Teker Teker": {
      "main": [
        [
          {
            "node": "ğŸ“ Mesaj HazÄ±rla",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ Mesaj HazÄ±rla": {
      "main": [
        [
          {
            "node": "ğŸ“± WhatsApp GÃ¶nder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“± WhatsApp GÃ¶nder": {
      "main": [
        [
          {
            "node": "ğŸ“ WhatsApp Durumu GÃ¼ncelle",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ WhatsApp Durumu GÃ¼ncelle": {
      "main": [
        [
          {
            "node": "â³ 5sn Bekle",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â³ 5sn Bekle": {
      "main": [
        [
          {
            "node": "ğŸ”„ Sonraki",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”„ Sonraki": {
      "main": [
        [
          {
            "node": "ğŸ”€ Teker Teker",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}
