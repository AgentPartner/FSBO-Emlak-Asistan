{
  "name": "ğŸ”„ FSBO Manuel Arama Tetikleme",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "trigger-call",
        "options": {
          "responseMode": "responseNode"
        }
      },
      "id": "webhook-manual",
      "name": "ğŸ”” Manuel Tetikleme",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [0, 0],
      "webhookId": "trigger-call"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-lead-id",
              "leftValue": "={{ $json.body.lead_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-params",
      "name": "â“ Lead ID Var mÄ±?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [220, 0]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT * FROM leads WHERE id = {{ $json.body.lead_id }} OR ilan_id = '{{ $json.body.lead_id }}'",
        "options": {}
      },
      "id": "get-lead",
      "name": "ğŸ“‹ Lead Bilgisi Al",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [440, -100],
      "credentials": {
        "postgres": {
          "id": "postgres-db",
          "name": "PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "lead-exists",
              "leftValue": "={{ $json.length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-lead-exists",
      "name": "â“ Lead Bulundu mu?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [660, -100]
    },
    {
      "parameters": {
        "jsCode": "// Vapi.ai iÃ§in dinamik prompt oluÅŸtur\nconst lead = $input.first().json;\n\nlet mulkAciklama = '';\nswitch(lead.mulk_tipi) {\n  case 'konut':\n    mulkAciklama = `${lead.oda_sayisi || ''} ${lead.metrekare ? lead.metrekare + ' metrekare' : ''} daireniz`;\n    break;\n  case 'arsa':\n    mulkAciklama = `${lead.metrekare ? lead.metrekare + ' metrekare' : ''} arsanÄ±z`;\n    break;\n  case 'isyeri':\n    mulkAciklama = `ticari mÃ¼lkÃ¼nÃ¼z`;\n    break;\n  default:\n    mulkAciklama = 'mÃ¼lkÃ¼nÃ¼z';\n}\n\nconst ilanTarihi = new Date(lead.ilan_tarihi);\nconst gunFarki = Math.floor((Date.now() - ilanTarihi) / (1000 * 60 * 60 * 24));\n\nlet aciliyetMesaji = '';\nif (gunFarki > 30) {\n  aciliyetMesaji = 'Ä°lanÄ±nÄ±z bir sÃ¼redir yayÄ±nda, doÄŸru alÄ±cÄ±yÄ± bulmak zaman alabiliyor deÄŸil mi?';\n} else if (gunFarki > 14) {\n  aciliyetMesaji = 'Ä°lanÄ±nÄ±za ilgi nasÄ±l, beklentilerinizi karÅŸÄ±lÄ±yor mu?';\n} else {\n  aciliyetMesaji = 'Yeni ilanÄ±nÄ±zÄ± gÃ¶rdÃ¼m, satÄ±ÅŸ sÃ¼recinizi hÄ±zlandÄ±rmak ister misiniz?';\n}\n\nconst systemPrompt = `Sen deneyimli bir emlak danÄ±ÅŸmanÄ±sÄ±n. MÃ¼ÅŸteriyle nazik, profesyonel ve ikna edici konuÅŸ.\n\nMÃ¼ÅŸteri Bilgileri:\n- Ä°sim: ${lead.ilan_sahibi || 'DeÄŸerli MÃ¼ÅŸterimiz'}\n- MÃ¼lk: ${mulkAciklama}\n- Konum: ${lead.il || ''} ${lead.ilce || ''}\n- Fiyat: ${lead.fiyat_formatted || 'BelirtilmemiÅŸ'}\n\nAÃ§Ä±lÄ±ÅŸ: \"${aciliyetMesaji}\"\n\nHedef: Ãœcretsiz deÄŸerleme iÃ§in randevu al.`;\n\nreturn [{\n  json: {\n    ...lead,\n    system_prompt: systemPrompt,\n    first_message: `Merhaba, ben AyÅŸe, Prestij Emlak'tan arÄ±yorum. ${lead.il || ''} ${lead.ilce || ''}'deki ilanÄ±nÄ±zÄ± gÃ¶rdÃ¼m. KÄ±sa bir dakikanÄ±z var mÄ±?`\n  }\n}];"
      },
      "id": "prepare-call",
      "name": "ğŸ§  Arama HazÄ±rla",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [880, -100]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.vapi.ai/call/phone",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"phoneNumberId\": \"{{$env.VAPI_PHONE_NUMBER_ID}}\",\n  \"customer\": {\n    \"number\": \"+90{{ $json.telefon.replace(/[^0-9]/g, '') }}\",\n    \"name\": \"{{ $json.ilan_sahibi || 'MÃ¼ÅŸteri' }}\"\n  },\n  \"assistant\": {\n    \"model\": {\n      \"provider\": \"anthropic\",\n      \"model\": \"claude-sonnet-4-20250514\",\n      \"temperature\": 0.7,\n      \"systemPrompt\": {{ JSON.stringify($json.system_prompt) }}\n    },\n    \"voice\": {\n      \"provider\": \"elevenlabs\",\n      \"voiceId\": \"pNInz6obpgDQGcFmaJgB\",\n      \"model\": \"eleven_turbo_v2_5\"\n    },\n    \"firstMessage\": {{ JSON.stringify($json.first_message) }},\n    \"recordingEnabled\": true,\n    \"maxDurationSeconds\": 600\n  },\n  \"serverUrl\": \"{{$env.WEBHOOK_BASE_URL}}/webhook/vapi-callback\"\n}"
      },
      "id": "make-call",
      "name": "ğŸ“ AramayÄ± BaÅŸlat",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1100, -100],
      "credentials": {
        "httpHeaderAuth": {
          "id": "vapi-api",
          "name": "Vapi API Key"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "schema": "public",
        "table": "leads",
        "updateKey": "id",
        "columns": "son_arama, arama_sayisi, vapi_call_id, durum",
        "options": {}
      },
      "id": "update-lead",
      "name": "ğŸ“ Lead GÃ¼ncelle",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1320, -100],
      "credentials": {
        "postgres": {
          "id": "postgres-db",
          "name": "PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": true,\n  \"message\": \"Arama baÅŸlatÄ±ldÄ±\",\n  \"call_id\": \"{{ $json.id }}\",\n  \"lead\": {\n    \"id\": {{ $('ğŸ“‹ Lead Bilgisi Al').item.json.id }},\n    \"baslik\": \"{{ $('ğŸ“‹ Lead Bilgisi Al').item.json.baslik }}\",\n    \"telefon\": \"{{ $('ğŸ“‹ Lead Bilgisi Al').item.json.telefon }}\"\n  }\n}",
        "options": {}
      },
      "id": "response-success",
      "name": "âœ… BaÅŸarÄ±lÄ± YanÄ±t",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1540, -100]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"success\": false,\n  \"error\": \"Lead bulunamadÄ±\"\n}",
        "options": {
          "responseCode": 404
        }
      },
      "id": "response-not-found",
      "name": "âŒ Lead BulunamadÄ±",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [880, 50]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"success\": false,\n  \"error\": \"lead_id parametresi gerekli\"\n}",
        "options": {
          "responseCode": 400
        }
      },
      "id": "response-bad-request",
      "name": "âŒ Parametre Eksik",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [440, 100]
    }
  ],
  "connections": {
    "ğŸ”” Manuel Tetikleme": {
      "main": [
        [
          {
            "node": "â“ Lead ID Var mÄ±?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â“ Lead ID Var mÄ±?": {
      "main": [
        [
          {
            "node": "ğŸ“‹ Lead Bilgisi Al",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "âŒ Parametre Eksik",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‹ Lead Bilgisi Al": {
      "main": [
        [
          {
            "node": "â“ Lead Bulundu mu?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â“ Lead Bulundu mu?": {
      "main": [
        [
          {
            "node": "ğŸ§  Arama HazÄ±rla",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "âŒ Lead BulunamadÄ±",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ§  Arama HazÄ±rla": {
      "main": [
        [
          {
            "node": "ğŸ“ AramayÄ± BaÅŸlat",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ AramayÄ± BaÅŸlat": {
      "main": [
        [
          {
            "node": "ğŸ“ Lead GÃ¼ncelle",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ Lead GÃ¼ncelle": {
      "main": [
        [
          {
            "node": "âœ… BaÅŸarÄ±lÄ± YanÄ±t",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}
