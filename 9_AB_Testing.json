{
  "name": "ğŸ§ª FSBO A/B Test YÃ¶netimi",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "GET",
        "path": "ab-test/variants",
        "options": {}
      },
      "id": "get-variants",
      "name": "ğŸ”” VaryantlarÄ± Listele",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [0, 0],
      "webhookId": "ab-test-variants"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM ab_test_variants WHERE aktif = true ORDER BY created_at DESC",
        "options": {}
      },
      "id": "list-variants",
      "name": "ğŸ“‹ Aktif Varyantlar",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [220, 0],
      "credentials": {
        "postgres": {
          "id": "postgres-db",
          "name": "PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, variants: $input.all().map(i => i.json) }) }}",
        "options": {}
      },
      "id": "response-variants",
      "name": "ğŸ“¤ YanÄ±t",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [440, 0]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "ab-test/create",
        "options": {}
      },
      "id": "create-variant",
      "name": "ğŸ”” Varyant OluÅŸtur",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [0, 200],
      "webhookId": "ab-test-create"
    },
    {
      "parameters": {
        "operation": "insert",
        "schema": "public",
        "table": "ab_test_variants",
        "columns": "isim, aciklama, test_tipi, prompt_degisiklik, agirlik, aktif",
        "options": {}
      },
      "id": "insert-variant",
      "name": "ğŸ’¾ Varyant Kaydet",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [220, 200],
      "credentials": {
        "postgres": {
          "id": "postgres-db",
          "name": "PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{ \"success\": true, \"message\": \"Varyant oluÅŸturuldu\" }",
        "options": {}
      },
      "id": "response-created",
      "name": "âœ… OluÅŸturuldu",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [440, 200]
    },
    {
      "parameters": {
        "httpMethod": "GET",
        "path": "ab-test/results",
        "options": {}
      },
      "id": "get-results",
      "name": "ğŸ”” Test SonuÃ§larÄ±",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [0, 400],
      "webhookId": "ab-test-results"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  v.id,\n  v.isim,\n  v.test_tipi,\n  COUNT(cl.id) as toplam_arama,\n  SUM(CASE WHEN cl.randevu_alindi THEN 1 ELSE 0 END) as randevu,\n  ROUND(100.0 * SUM(CASE WHEN cl.randevu_alindi THEN 1 ELSE 0 END) / NULLIF(COUNT(cl.id), 0), 2) as donusum_orani,\n  ROUND(AVG(cl.musteri_ilgisi), 2) as ort_ilgi,\n  ROUND(AVG(cl.sure_saniye), 0) as ort_sure\nFROM ab_test_variants v\nLEFT JOIN call_logs cl ON cl.ab_variant_id = v.id\nWHERE v.aktif = true\nGROUP BY v.id, v.isim, v.test_tipi\nORDER BY donusum_orani DESC NULLS LAST",
        "options": {}
      },
      "id": "calculate-results",
      "name": "ğŸ“Š SonuÃ§larÄ± Hesapla",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [220, 400],
      "credentials": {
        "postgres": {
          "id": "postgres-db",
          "name": "PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const results = $input.all().map(i => i.json);\n\n// Ä°statistiksel anlamlÄ±lÄ±k hesapla (basitleÅŸtirilmiÅŸ)\nconst withSignificance = results.map(r => {\n  const n = r.toplam_arama || 0;\n  const p = (r.donusum_orani || 0) / 100;\n  \n  // Wilson score interval\n  const z = 1.96; // 95% confidence\n  const denominator = 1 + z*z/n;\n  const centre = p + z*z/(2*n);\n  const interval = z * Math.sqrt((p*(1-p) + z*z/(4*n))/n);\n  \n  return {\n    ...r,\n    confidence_low: n > 0 ? Math.max(0, ((centre - interval) / denominator) * 100).toFixed(2) : 0,\n    confidence_high: n > 0 ? Math.min(100, ((centre + interval) / denominator) * 100).toFixed(2) : 0,\n    sample_size_adequate: n >= 100\n  };\n});\n\n// En iyi performansÄ± bul\nconst best = withSignificance.reduce((a, b) => \n  (b.donusum_orani || 0) > (a.donusum_orani || 0) ? b : a\n, {});\n\nreturn [{\n  json: {\n    results: withSignificance,\n    best_variant: best.isim || 'Yetersiz veri',\n    recommendation: best.sample_size_adequate \n      ? `\"${best.isim}\" varyantÄ± %${best.donusum_orani} dÃ¶nÃ¼ÅŸÃ¼m oranÄ±yla en iyi performansÄ± gÃ¶steriyor.`\n      : 'HenÃ¼z yeterli veri yok. En az 100 arama gerekli.'\n  }\n}];"
      },
      "id": "analyze-results",
      "name": "ğŸ§  SonuÃ§ Analizi",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [440, 400]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, ...$json }) }}",
        "options": {}
      },
      "id": "response-results",
      "name": "ğŸ“¤ SonuÃ§ YanÄ±tÄ±",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [660, 400]
    },
    {
      "parameters": {
        "httpMethod": "GET",
        "path": "ab-test/select-variant",
        "options": {}
      },
      "id": "select-variant",
      "name": "ğŸ”” Varyant SeÃ§ (Weighted)",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [0, 600],
      "webhookId": "select-variant"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM ab_test_variants WHERE aktif = true",
        "options": {}
      },
      "id": "get-active-variants",
      "name": "ğŸ“‹ Aktif Varyantlar Al",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [220, 600],
      "credentials": {
        "postgres": {
          "id": "postgres-db",
          "name": "PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Weighted random selection\nconst variants = $input.all().map(i => i.json);\n\nif (variants.length === 0) {\n  return [{ json: { selected: null, variant_id: null } }];\n}\n\nconst totalWeight = variants.reduce((sum, v) => sum + (v.agirlik || 1), 0);\nlet random = Math.random() * totalWeight;\n\nlet selected = variants[0];\nfor (const variant of variants) {\n  random -= (variant.agirlik || 1);\n  if (random <= 0) {\n    selected = variant;\n    break;\n  }\n}\n\nreturn [{\n  json: {\n    variant_id: selected.id,\n    variant_name: selected.isim,\n    prompt_modification: selected.prompt_degisiklik\n  }\n}];"
      },
      "id": "weighted-selection",
      "name": "ğŸ² Weighted Selection",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [440, 600]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, ...$json }) }}",
        "options": {}
      },
      "id": "response-selected",
      "name": "ğŸ“¤ SeÃ§ilen Varyant",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [660, 600]
    }
  ],
  "connections": {
    "ğŸ”” VaryantlarÄ± Listele": {
      "main": [[{"node": "ğŸ“‹ Aktif Varyantlar", "type": "main", "index": 0}]]
    },
    "ğŸ“‹ Aktif Varyantlar": {
      "main": [[{"node": "ğŸ“¤ YanÄ±t", "type": "main", "index": 0}]]
    },
    "ğŸ”” Varyant OluÅŸtur": {
      "main": [[{"node": "ğŸ’¾ Varyant Kaydet", "type": "main", "index": 0}]]
    },
    "ğŸ’¾ Varyant Kaydet": {
      "main": [[{"node": "âœ… OluÅŸturuldu", "type": "main", "index": 0}]]
    },
    "ğŸ”” Test SonuÃ§larÄ±": {
      "main": [[{"node": "ğŸ“Š SonuÃ§larÄ± Hesapla", "type": "main", "index": 0}]]
    },
    "ğŸ“Š SonuÃ§larÄ± Hesapla": {
      "main": [[{"node": "ğŸ§  SonuÃ§ Analizi", "type": "main", "index": 0}]]
    },
    "ğŸ§  SonuÃ§ Analizi": {
      "main": [[{"node": "ğŸ“¤ SonuÃ§ YanÄ±tÄ±", "type": "main", "index": 0}]]
    },
    "ğŸ”” Varyant SeÃ§ (Weighted)": {
      "main": [[{"node": "ğŸ“‹ Aktif Varyantlar Al", "type": "main", "index": 0}]]
    },
    "ğŸ“‹ Aktif Varyantlar Al": {
      "main": [[{"node": "ğŸ² Weighted Selection", "type": "main", "index": 0}]]
    },
    "ğŸ² Weighted Selection": {
      "main": [[{"node": "ğŸ“¤ SeÃ§ilen Varyant", "type": "main", "index": 0}]]
    }
  },
  "settings": {"executionOrder": "v1"}
}
